## redis如何做一次数据同步
* 第一阶段 主从建立连接 协商同步
  * 从库向主库发送psync命令，表示要进行数据的同步，主库根据这个参数来启动复制，psync命令包含主库的runid和复制进度的offset两个参数
    * runid 是每个实例启动时都会自动生成一个随机ID
    * offset 此时设为-1 表示第一次复制
  * FULLRESYNC 响应表示第一次复制采用的全量复制，也就是说，主库会把当前所有的数据都复制给从库。
* 第二阶段
  * 主库将所有数据同步给从库。从库收到数据后，在本地完成数据加载。这个过程依赖于内存快照生成的 RDB 文件
    * 主库执行bgsave命令，生成rdb文件，接着将文件发给从库，从库接收到rdb文件后，会先清空当前数据库，然后加载rdb文件
    * 在主库将数据同步给从库的过程中，主库不会阻塞，仍然可以正常接收请求
    * 为了保证主从库的数据一致性，主库会在内存中用专门的replication buffer 记录rdb文件生成后收到的所有写操作
* 第三阶段
  * 主库会把第二阶段执行过程中新收到的写命令，再发送给从库。具体的操作是，当主库完成 RDB 文件发送后，就会把此时 replication buffer 中的修改操作发给从库，从库再重新执行这些操作
  
## 主从级联模式分担全量复制的主库压力
### 背景
* 分析主从库之间第一次同步过程，我们发现，对主库来说，需要完成两个耗时的操作：
  * 生成rdb文件和传输rdb文件
  
### 主-从-从
* 将主库生成的rdb和传输的rdb的压力分散到从库上