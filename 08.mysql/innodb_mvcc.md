# 定义
* InnoDB是一种多版本存储引擎。它保存有关更改行旧版本的信息，以支持事务功能，如并发和回滚
* 此信息存储在称为回滚段的数据结构中的撤消表空间中。InnoDB 使用回滚段中的信息来执行事务回滚中所需的撤消操作

* 在内部， InnoDB 向存储在数据库中的每一行添加三个字段：
  * 一个 6 字节的 DB_TRX_ID 字段指示插入或更新该行的最后一个事务的事务标识符。
  * 一个 7 字节的 DB_ROLL_PTR 字段称为滚动指针。回滚指针指向一条写入回滚段的撤销日志记录
  * 一个 6 字节的 DB_ROW_ID 字段包含一个行 ID，该行 ID 在插入新行时单调增加。如果 InnoDB 自动生成聚簇索引，则该索引包含行 ID 值。否则， DB_ROW_ID 列不会出现在任何索引中。


回滚段中的undo logs分为insert和update undo logs
  * Insert undo logs只在事务回滚时需要，一旦事务提交就可以丢弃。
  * 更新撤消日志也用于一致读取，但只有在不存在事务时才能丢弃它们， InnoDB 已为其分配快照，而在一致读取中可能需要更新撤消日志中的信息来构建早期版本数据库行。
  * 建议定期提交事务,包括仅发出一致读取的事务。否则，innodb无法丢弃更新撤消日志中的数据，回滚段可能会变得太大，填满它所在的撤消表空间
  * 回滚段中撤销日志记录的物理大小通常比相应的插入或更新行要小。您可以使用此信息来计算回滚段所需的空间。
  * 在 InnoDB 多版本方案中，当您使用 SQL 语句删除行时，它不会立即从数据库中物理删除。 InnoDB 只有在丢弃为删除而写的update undo log记录时，才会物理删除对应的行及其索引记录。这种删除操作称为清除，速度非常快，通常与执行删除的 SQL 语句所用的时间顺序相同。
  * 在InnoDB多版本控制方案中，当您使用SQL语句删除一行时，该行不会立即从数据库中物理删除。仅当InnoDB丢弃为删除编写的更新撤消日志记录时，它才会物理上删除相应的行和其索引记录。这个移除操作称为清除(purge)，通常非常快速，通常与执行删除操作的SQL语句所需时间相同。
  * 如果您在表中以大约相同的速率批量插入和删除行，则清除线程可能会开始滞后，由于所有“死”行而使表变得越来越大，从而使一切都受到磁盘限制并且非常缓慢。 在这种情况下，请控制新行操作，并通过调整innodb_max_purge_lag系统变量为清除线程分配更多资源

# 多版本和二级索引
* InnoDB 多版本并发控制 (MVCC) 对待二级索引的方式与聚集索引不同。聚集索引中的记录就地更新，它们的隐藏系统列指向撤消日志条目，从中可以重建早期版本的记录。与聚集索引记录不同，二级索引记录不包含隐藏的系统列，也不会就地更新。
* 当更新二级索引列时，旧的二级索引记录被删除标记，插入新记录，并最终清除删除标记的记录。当二级索引记录被删除标记或二级索引页面被更新的事务更新时， InnoDB 在聚簇索引中查找数据库记录。在聚簇索引中，检查记录的 DB_TRX_ID ，如果记录在读取事务启动后被修改，则从撤消日志中检索记录的正确版本。
* 如果二级索引记录被标记为删除或二级索引页面被较新的事务更新，则不使用覆盖索引技术。 InnoDB 不是从索引结构中返回值，而是在聚集索引中查找记录。
* 但是，如果启用了索引条件下推 (ICP) 优化，并且可以仅使用索引中的字段来评估 WHERE 条件的一部分，则 MySQL 服务器仍将这部分 WHERE 条件下推到存储引擎使用索引对其进行评估的位置。如果找不到匹配的记录，则避免聚簇索引查找。如果找到匹配的记录，即使在删除标记的记录中， InnoDB 也会在聚簇索引中查找记录。